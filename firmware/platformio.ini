; =============================================================================
; TurtlPass Firmware — Multi-board RP2040/RP2350 build setup
;
; Docs: https://arduino-pico.readthedocs.io/en/latest/platformio.html
; Platform: https://github.com/maxgerhardt/platform-raspberrypi.git
; =============================================================================

; =======================================
; PlatformIO Configuration
; =======================================
[platformio]
build_cache_dir = ~/.platformio/cache ; lets PlatformIO reuse compiled libraries across projects
core_dir = ~/.platformio/core

; =============================================================================
; Base environment: shared configuration for all RP2040/RP2350 boards
; =============================================================================
[env:base]
platform = https://github.com/maxgerhardt/platform-raspberrypi.git
board = pico
framework = arduino
build_type = release
; Earle Philhower’s Arduino-Pico core
board_build.core = earlephilhower
; Flash filesystem (Earle Philhower's Arduino-Pico core)
board_build.filesystem_size = 0.5m
; USB VID/PID: https://pid.codes/1209/FA55/
board_build.arduino.earlephilhower.usb_manufacturer = TurtlPass
board_build.arduino.earlephilhower.usb_product = TurtlPass Firmware
board_build.arduino.earlephilhower.usb_vid = 0x1209
board_build.arduino.earlephilhower.usb_pid = 0xFA55
; Compiler and SDK include paths
build_flags =
    -D__TURTLPASS_VERSION__=\"3.0.0\"
    -DPIO_BOARD_NAME=\"$BOARD\"
    -DUSE_TINYUSB                       ; Adafruit TinyUSB
    -DFASTLED_INTERNAL                  ; Remove annoying FastLED pragma messages
; Common libraries
lib_deps =
    https://github.com/FastLED/FastLED.git
; Serial monitor
monitor_speed = 115200
monitor_filters = send_on_enter
monitor_echo = yes


; =======================================
; Raspberry Pi Pico (RP2040)
; =======================================
; Build: 
; $ pio run -e pico
; Upload: 
; $ pio run -e pico -t upload
; =======================================
[env:pico]
extends = env:base
board = pico
build_flags = ${env:base.build_flags}

; =======================================
; Raspberry Pi Pico W (RP2040 + Wi-Fi)
; =======================================
[env:rpipicow]
extends = env:base
board = rpipicow
build_flags = ${env:base.build_flags}

; =======================================
; Raspberry Pi Pico 2 (RP2350)
; =======================================
[env:rpipico2]
extends = env:base
board = rpipico2
build_flags = ${env:base.build_flags}

; =======================================
; Raspberry Pi Pico 2W (RP2350 + Wi-Fi)
; =======================================
[env:rpipico2w]
extends = env:base
board = rpipico2w
build_flags = ${env:base.build_flags}

; =======================================
; Adafruit Feather RP2040
; =======================================
[env:adafruit_feather]
extends = env:base
board = adafruit_feather
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Adafruit QT Py RP2040
; =======================================
[env:adafruit_qtpy]
extends = env:base
board = adafruit_qtpy
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Adafruit Trinkey QT2040
; =======================================
[env:adafruit_trinkeyrp2040qt]
extends = env:base
board = adafruit_trinkeyrp2040qt
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Seeed Xiao RP2040
; =======================================
[env:seeed_xiao_rp2040]
extends = env:base
board = seeed_xiao_rp2040
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Seeed Xiao RP2350
; =======================================
[env:seeed_xiao_rp2350]
extends = env:base
board = seeed_xiao_rp2350
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Waveshare RP2040-Zero
; =======================================
[env:waveshare_rp2040_zero]
extends = env:base
board = waveshare_rp2040_zero
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Waveshare RP2350-Zero
; =======================================
[env:waveshare_rp2350_zero]
extends = env:base
board = waveshare_rp2350_zero
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_IS_RGB__=true     ; RGB LED

; =======================================
; Generic RP2040
; =======================================
[env:generic]
extends = env:base
board = generic
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_PIN__=25          ; Example, Pico built-in LED = GPIO 25
    -D__TURTLPASS_LED_IS_RGB__=false    ; Example, Pico built-in LED = Single-color

; =======================================
; Generic RP2350
; =======================================
[env:generic_rp2350]
extends = env:base
board = generic_rp2350
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_PIN__=25          ; Example, RP2350-Zero built-in LED = GPIO 16
    -D__TURTLPASS_LED_IS_RGB__=false    ; Example, RP2350-Zero built-in LED = RGB



; =============================================================================
; [Embedded Tests] — Run on RP2040 hardware (inherits base config)
; =============================================================================
; Run:
; $ pio test -e pico-tests
; =============================================================================
; $ pio test -e pico-tests --filter embedded/test_seedmanager_basic
; $ pio test -e pico-tests --filter embedded/test_seedmanager_crypto
; $ pio test -e pico-tests --filter embedded/test_seedmanager_eeprom
; $ pio test -e pico-tests --filter embedded/test_seedmanager_slots
; $ pio test -e pico-tests --filter embedded/test_storage_basic
; $ pio test -e pico-tests --filter embedded/test_storage_full
; $ pio test -e pico-tests --filter embedded/test_storage_roundtrip
; =============================================================================
[env:pico-tests]
extends = env:base
board = pico
framework = arduino
test_build_src = true
test_framework = unity
test_filter = embedded/
monitor_speed = 115200
; Keep firmware defines from base and override where needed
build_flags =
    ${env:base.build_flags}
    -D__TURTLPASS_LED_PIN__=25
    -D__TURTLPASS_LED_IS_RGB__=false
    -I.pio/libdeps/pico-tests/FastLED/src
; Only build the components relevant to tests
build_src_filter =
    +<src/*>
    +<src/crypto/*>
    +<src/storage/*>
    -<src/main.cpp>     ; exclude firmware entry point
; Test libraries
lib_deps =
    https://github.com/FastLED/FastLED.git#3.10.3


; =======================================
; Raspberry Pi Pico W
; =======================================
; Run:
; $ pio test -e pico_w-tests
; =======================================
[env:pico_w-tests]
extends = env:base
board = rpipicow
test_build_src = true
test_framework = unity
test_filter = embedded/*
build_flags = ${env:base.build_flags}
build_src_filter = ${env:pico-tests.build_src_filter}



; =============================================================================
; [Native Tests] — Run on host machine (no hardware)
; =============================================================================
; Run: 
; $ pio test -e native
; =============================================================================
; $ pio test -e native --filter native/test_key_derivation
; $ pio test -e native --filter native/test_encryption
; =============================================================================
[env:native]
platform = native
test_framework = unity
test_build_src = true
test_filter = native/*
test_ignore = native/common/*
build_flags =
    -std=c++17
    -I src
    -I lib
    -Itest/native/common
    -D ARDUINO=10819        ; Fake Arduino version number
    -D BOOTSEL=false
    -I.pio/libdeps/native/FastLED/src
    -DFASTLED_INTERNAL
    -DFASTLED_ALLOW_INTERRUPTS=0
    -DFASTLED_REGISTER=     ; neutralize macro
lib_deps =
    https://github.com/FastLED/FastLED.git
build_src_filter =
    +<src/*>                ; include everything in src/
    +<lib/*>
    -<src/keyboard/*>
    -<src/ui/*>
